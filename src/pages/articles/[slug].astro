---
import type { GetStaticPaths } from 'astro';
import Layout from '../../layouts/Layout.astro';
import ExcalidrawArticle from '../../components/ExcalidrawArticle.tsx';

interface ExcalidrawArticleData {
  elements: readonly any[];
  appState: any;
  files?: Record<string, any>;
}

export const getStaticPaths: GetStaticPaths = async () => {
  const jsonModules = import.meta.glob('/src/content/articles/*.json', { eager: true }) as Record<string, { default: ExcalidrawArticleData } | ExcalidrawArticleData>;
  const excalModules = import.meta.glob('/src/content/articles/*.excalidraw', { eager: true, query: '?raw', import: 'default' }) as Record<string, string>;

  const entries: { filePath: string; articleData: ExcalidrawArticleData }[] = [];

  for (const [filePath, mod] of Object.entries(jsonModules)) {
    const articleData = (mod as any).default ?? mod;
    entries.push({ filePath, articleData });
  }

  for (const [filePath, raw] of Object.entries(excalModules)) {
    const articleData = JSON.parse(raw) as ExcalidrawArticleData;
    entries.push({ filePath, articleData });
  }

  return entries.map(({ filePath, articleData }) => {
    const fileName = filePath.split('/').pop() || '';
    const slug = fileName.replace(/\.(json|excalidraw)$/i, '');
    return {
      params: { slug },
      props: { articleData }
    };
  });
};

const { articleData } = Astro.props as { articleData: ExcalidrawArticleData };
---

<Layout title="Artículo" description="Un artículo de mi blog visual.">
  <article class="mt-16 max-w-5xl mx-auto px-4">
    <ExcalidrawArticle client:only="react" articleData={articleData} />
  </article>
</Layout>
